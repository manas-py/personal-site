<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Personal Site — Layered Scene with Lights Animation</title>
<style>
  :root{
    --overlay-opacity:2.0;
    --overlay-blend:overlay;
  }

  /* Basic reset */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:#000;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:#fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* ---------- Scene (full-bleed) ---------- */
  .scene{
    position:relative;
    width:100vw;
    height:100vh;
    min-height:100dvh;
    overflow:hidden;
    isolation:isolate;
  }

  /* Background and overlay as pseudo-elements (true layers) */
  .scene::before,
  .scene::after{
    content:"";
    position:absolute; inset:0;
    background-repeat:no-repeat;
    background-size:cover;
    background-position:center;
    pointer-events:none;
  }
  .scene::before{ z-index:0; } /* background */
  .scene::after { z-index:3; mix-blend-mode:var(--overlay-blend); opacity:var(--overlay-opacity); } /* overlay */

  /* ---------- Lights layer (GIF fallback or PNG sequence) ---------- */
  /* .lights is an element between background and stickers */
  .lights{
    position:absolute; inset:0;
    z-index:1;                      /* above background, below stickers */
    background-repeat:no-repeat;
    background-position:center;
    background-size:auto;           /* native pixel size by default */
    pointer-events:none;
  }

  /* ---------- Stickers (ads) - show at intrinsic size (100% of their image) ---------- */
  .slot{
    position:absolute;
    z-index:2;            /* between lights(1) and overlay(3) */
    /* NOTE: width not set here so images render at natural intrinsic size.
       Use --t and --l to position each slot. */
    top:var(--t);
    left:var(--l);
  }
  .sticker{ display:inline-block; text-decoration:none; }
  .sticker img{
    display:block; width:auto; height:auto; /* intrinsic size */
    max-width:none;
    filter:drop-shadow(0 8px 20px rgba(0,0,0,.35));
    -webkit-user-drag:none;
  }

  /* ---------- PC framing (restored stable view) ---------- */
  .pc::before{ background-image:url('/pc/bg.png'); background-position:center top -8%; }
  .pc::after { background-image:url('/pc/overlay.png'); background-position:center top -8%; }

  /* ---------- MOBILE framing (fit by width — crop vertical as needed) ---------- */
  .mobile::before{ background-image:url('/mobile/bg.png'); }
  .mobile::after { background-image:url('/mobile/overlay.png'); }
  @media (max-width:800px){
    .mobile::before, .mobile::after {
      background-size:100% auto;     /* force bg to fit by width */
      background-position:top center;
    }
    .mobile .lights {
      /* ensure lights layer stays centered; frames are shown at native size */
      background-size:auto;
      background-position:center;
    }
  }

  /* ---------- Desktop ad positions (you can tweak percentages) ---------- */
  .pc .slot-1{ --t:8%;  --l:12%; }   /* FiradPatra */
  .pc .slot-2{ --t:7%;  --l:37%; }   /* Post/Welcome */
  .pc .slot-3{ --t:7%;  --l:70%; }   /* Kathmandu */
  .pc .slot-4{ --t:36%; --l:22%; }   /* YouTube */
  .pc .slot-5{ --t:36%; --l:69%; }   /* Px1rt */
  .pc .slot-6{ --t:12%; --l:74%; }   /* Buy image */
  .pc .slot-7{ --t:12%; --l:79%; }   /* Download image */

  /* ---------- Mobile ad positions (defaults you can tweak) ---------- */
  .mobile .slot-1{ --t:6%;  --l:6%; }
  .mobile .slot-2{ --t:14%; --l:20%; }
  .mobile .slot-3{ --t:8%;  --l:46%; }
  .mobile .slot-4{ --t:54%; --l:8%;  }
  .mobile .slot-5{ --t:55%; --l:62%; }
  .mobile .slot-6{ --t:18%; --l:70%; } /* Buy on mobile */
  .mobile .slot-7{ --t:18%; --l:78%; } /* Download on mobile */

  /* ---------- Footer navigation (text-only) — Helvetica requested for footer text ---------- */
  .footer-nav{
    position:fixed; left:0; right:0; bottom:14px;
    z-index:6; display:flex; gap:0; padding:0 18px;
    justify-content:space-between; align-items:center;
    pointer-events:none; /* links will re-enable pointer-events */
  }
  .footer-left, .footer-center, .footer-right{
    width:33%; display:flex; align-items:center; pointer-events:auto;
  }
  .footer-left{ justify-content:flex-start; }
  .footer-center{ justify-content:center; }
  .footer-right{ justify-content:flex-end; }
  .footer-nav a{
    font-family: "Helvetica", Arial, sans-serif; /* Helvetica as requested */
    color:#fff; text-decoration:none; font-weight:600; letter-spacing:.2px;
    text-shadow:0 3px 8px rgba(0,0,0,.6);
    pointer-events:auto;
  }

  /* ---------- Modal (newsletter) — kept from prior version ---------- */
  dialog.modal{ position:fixed; inset:0; display:none; place-items:center; z-index:7; background:rgba(0,0,0,.45); }
  dialog.modal[open]{ display:grid; }
  .sheet{ background:rgba(18,18,18,.96); color:#fff; padding:18px; border-radius:14px; min-width:min(92vw,480px); }
  .sheet input[type=email]{ width:100%; padding:10px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#fff }
  .sheet button{ padding:10px 14px; border-radius:10px; background:#ffd400; border:0; font-weight:700; cursor:pointer; }

  /* Debug outlines toggle (press "d") */
  body.debug .slot{ outline:2px dashed rgba(255,255,255,.85) }
  body.debug .slot::after{
    content:attr(data-slot);
    position:absolute; top:-1rem; left:-1rem;
    background:#ff2;color:#111;border-radius:6px;padding:.25rem .35rem;font:600 12px/1.2 monospace;
  }
</style>
</head>
<body>

<!-- ================= PC SCENE ================= -->
<section class="scene pc" aria-label="Desktop scene">
  <!-- Lights layer (either GIF or PNG-sequence will be used by JS) -->
  <div class="lights" aria-hidden="true"></div>

  <!-- Ads: images rendered at their intrinsic (native) size.
       Comments included where you should put the target href for each poster. -->

  <div class="slot slot-1" data-slot="#1">
    <!-- TODO: replace href="#" with the target link for FP ad -->
    <a class="sticker" href="#" aria-label="FiradPatra">
      <img src="/pc/fp.png" alt="FiradPatra">
    </a>
  </div>

  <div class="slot slot-2" data-slot="#2">
    <!-- TODO: replace href="#" with the target link for the Welcome/Post ad -->
    <a class="sticker" href="#" aria-label="Welcome / Post">
      <img src="/pc/post.png" alt="Post / Welcome">
    </a>
  </div>

  <div class="slot slot-3" data-slot="#3">
    <!-- TODO: replace href="#" with the target link for Kathmandu -->
    <a class="sticker" href="#" aria-label="Kathmandu">
      <img src="/pc/ktm.png" alt="Kathmandu">
    </a>
  </div>

  <div class="slot slot-4" data-slot="#4">
    <!-- TODO: replace href="#" with the target link for YouTube -->
    <a class="sticker" href="#" aria-label="YouTube">
      <img src="/pc/yt.png" alt="YouTube">
    </a>
  </div>

  <div class="slot slot-5" data-slot="#5">
    <!-- TODO: replace href="#" with the target link for px1rt -->
    <a class="sticker" href="#" aria-label="Px1rt">
      <img src="/pc/px1rt.png" alt="Px1rt">
    </a>
  </div>

  <!-- Buy / Download images (now images, not buttons).
       Change the href value to the real URLs if you want them to navigate elsewhere. -->
  <div class="slot slot-6" data-slot="#buy">
    <!-- TODO: set href to buy link -->
    <a class="sticker" href="#" target="_blank" rel="noopener" aria-label="Buy">
      <img src="/pc/buy.png" alt="Buy">
    </a>
  </div>

  <div class="slot slot-7" data-slot="#download">
    <!-- download is wired to ktm.pdf by default; change if needed -->
    <a class="sticker" href="/ktm.pdf" download aria-label="Download Kathmandu PDF">
      <img src="/pc/download.png" alt="Download">
    </a>
  </div>
</section>

<!-- ================= MOBILE SCENE ================= -->
<section class="scene mobile" aria-label="Mobile scene">
  <div class="lights" aria-hidden="true"></div>

  <div class="slot slot-1" data-slot="#1">
    <!-- TODO: replace href="#" with FP link for mobile -->
    <a class="sticker" href="#" aria-label="FiradPatra">
      <img src="/mobile/fp.png" alt="FiradPatra">
    </a>
  </div>

  <div class="slot slot-2" data-slot="#2">
    <!-- TODO: replace href="#" with Post link for mobile -->
    <a class="sticker" href="#" aria-label="Welcome / Post">
      <img src="/mobile/post.png" alt="Post / Welcome">
    </a>
  </div>

  <div class="slot slot-3" data-slot="#3">
    <!-- TODO: replace href="#" with Kathmandu link for mobile -->
    <a class="sticker" href="#" aria-label="Kathmandu">
      <img src="/mobile/ktm.png" alt="Kathmandu">
    </a>
  </div>

  <div class="slot slot-4" data-slot="#4">
    <!-- TODO: replace href="#" with YouTube link for mobile -->
    <a class="sticker" href="#" aria-label="YouTube">
      <img src="/mobile/yt.png" alt="YouTube">
    </a>
  </div>

  <div class="slot slot-5" data-slot="#5">
    <!-- TODO: replace href="#" with px1rt link for mobile -->
    <a class="sticker" href="#" aria-label="Px1rt">
      <img src="/mobile/px1rt.png" alt="Px1rt">
    </a>
  </div>

  <div class="slot slot-6" data-slot="#buy">
    <!-- TODO: set href to buy link for mobile -->
    <a class="sticker" href="#" target="_blank" rel="noopener" aria-label="Buy">
      <img src="/mobile/buy.png" alt="Buy">
    </a>
  </div>

  <div class="slot slot-7" data-slot="#download">
    <a class="sticker" href="/ktm.pdf" download aria-label="Download Kathmandu PDF">
      <img src="/mobile/download.png" alt="Download">
    </a>
  </div>
</section>

<!-- ============== Footer (text-only nav) ============== -->
<nav class="footer-nav" aria-label="Footer navigation">
  <div class="footer-left"><a id="resume-link" href="#">Resume</a></div>
  <div class="footer-center"><a id="newsletter-open" href="#newsletter">Signup for Newsletter</a></div>
  <div class="footer-right"><a id="archive-link" href="#archive">Archive posts</a></div>
</nav>

<!-- ============== Newsletter modal (unchanged behaviour) ============== -->
<dialog class="modal" id="newsletter-modal" aria-labelledby="news-title">
  <div class="sheet">
    <h2 id="news-title">Join my newsletter</h2>
    <form id="newsletter-form">
      <label style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)">Email</label>
      <input id="email" name="email" type="email" placeholder="you@example.com" required autocomplete="email" />
      <div style="height:8px"></div>
      <button type="submit">Subscribe</button>
    </form>
    <p id="newsletter-msg" role="status" aria-live="polite" style="margin-top:10px"></p>
    <p style="opacity:.75;font-size:13px;margin-top:8px">No spam. I’ll only email when I publish new posts.</p>
  </div>
</dialog>

<script>
/* -------------------------------
   Lights animation loader
   - Preferred: use an already-created GIF at /pc/lights.gif and /mobile/lights.gif
   - Fallback: if GIF missing, animate the PNG sequence /pc/lights/lights0000..0015.png
     and /mobile/lights/lights0000..0015.png
   - Frames are shown at native size (background-size:auto) so they render at 100% size.
------------------------------- */
(function(){
  const FRAME_COUNT = 16; // lights0000.png .. lights0015.png
  const FPS = 12;
  const pad4 = n => String(n).padStart(4,'0');

  function tryUseGif(sceneEl, gifPath){
    // Try to fetch the gif with a short HEAD request to see if it exists.
    return fetch(gifPath, { method: 'HEAD' }).then(res => {
      if(res.ok){
        const layer = sceneEl.querySelector('.lights');
        layer.style.backgroundImage = `url("${gifPath}")`;
        // Make sure GIF fills appropriately:
        layer.style.backgroundSize = 'auto'; // native pixel size by default
        layer.style.backgroundPosition = getComputedStyle(sceneEl).getPropertyValue('--lights-position') || 'center';
        return true;
      }
      return false;
    }).catch(()=> false);
  }

  function buildFrameList(baseDir){
    const list = [];
    for(let i=0;i<FRAME_COUNT;i++){
      list.push(`${baseDir}/lights${pad4(i)}.png`);
    }
    return list;
  }

  function preloadFrames(urls){
    return Promise.all(urls.map(u => new Promise(res=>{
      const img = new Image();
      img.onload = ()=>res({u, ok:true});
      img.onerror = ()=>res({u, ok:false});
      img.src = u + `?v=1`; // small cache-bust for safety
    })));
  }

  function startSequence(sceneEl, frames, fps){
    const layer = sceneEl.querySelector('.lights');
    if(!layer || !frames.length) return;
    let i = 0, last = 0, interval = 1000/Math.max(1,fps);
    function tick(ts){
      if(!last) last = ts;
      const dt = ts - last;
      if(dt >= interval){
        layer.style.backgroundImage = `url("${frames[i]}")`;
        i = (i + 1) % frames.length;
        last = ts;
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  async function initFor(kind){
    const sceneEl = document.querySelector(`.${kind}`);
    if(!sceneEl) return;

    // First try a compiled GIF at the expected locations:
    const gifPath = `/${kind}/lights.gif`;
    const gifOk = await tryUseGif(sceneEl, gifPath);
    if(gifOk) return; // GIF present and used.

    // No gif: fallback to PNG sequence
    const frames = buildFrameList(`/${kind}/lights`);
    const results = await preloadFrames(frames);
    const ok = results.filter(r=>r.ok).map(r=>r.u);
    if(ok.length){
      // Use only successful frames
      startSequence(sceneEl, ok, FPS);
    } else {
      // If nothing found, hide the lights layer (no visual)
      const layer = sceneEl.querySelector('.lights');
      if(layer) layer.style.display = 'none';
    }
  }

  // Init both scenes (harmless if one isn't visible)
  initFor('pc');
  initFor('mobile');
})();

/* -------------------------------
   Newsletter modal & storage
   - Default behavior kept: stores in localStorage (for testing).
   - You told earlier you might move to a real backend. When ready we can swap submit handler.
------------------------------- */
(function(){
  const modal = document.getElementById('newsletter-modal');
  const open = document.getElementById('newsletter-open');
  const form = document.getElementById('newsletter-form');
  const msg = document.getElementById('newsletter-msg');

  open.addEventListener('click', e => { e.preventDefault(); modal.setAttribute('open',''); document.getElementById('email').focus(); });
  modal.addEventListener('click', e => { if(e.target === modal) modal.removeAttribute('open'); });
  addEventListener('keydown', e => { if(e.key === 'Escape') modal.removeAttribute('open'); });

  const KEY = 'newsletter_emails_v1';
  function loadList(){ try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{ return []; } }
  function saveList(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const email = (new FormData(form).get('email') || '').toString().trim().toLowerCase();
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ msg.textContent = 'Please enter a valid email address.'; return; }
    const list = loadList();
    if(list.some(x=>x.email===email)){ msg.textContent = 'You are already subscribed.'; return; }
    list.push({email, ts: new Date().toISOString()});
    saveList(list);
    msg.textContent = 'Subscribed (local test). When you connect a real service, this will send to your list.';
    form.reset();
    // NOTE: When you pick a real backend (Apps Script, Buttondown, etc.) replace this handler to POST to that endpoint.
  });

  // helpful export command (run in console)
  window.exportNewsletter = function(){
    const list = loadList();
    if(!list.length){ alert('No subscribers found in localStorage.'); return; }
    const csv = [['email','timestamp'], ...list.map(x=>[x.email,x.ts])].map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}), url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'newsletter_emails.csv'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };
})();

/* -------------------------------
   Utility: debug outlines toggle (press 'd')
------------------------------- */
addEventListener('keydown', e => {
  if(e.key.toLowerCase() === 'd') document.body.classList.toggle('debug');
}, {passive:true});
</script>
</body>
</html>
